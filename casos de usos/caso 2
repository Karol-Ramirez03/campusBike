//nuuevas ventas y detalles venta y actualizar el stock
procedimiento de insert y triggers para verificar el stock



&&&&&&&&&&&&&&&&&&&&&&&&&&&&&6
comprobar insert venta
DELIMITER $$ 
DROP PROCEDURE IF EXISTS registrarVenta$$
CREATE PROCEDURE registrarVenta(
    IN inClienteId VARCHAR(10),
    OUT outVentaId INT 
) 
BEGIN 
    /* Se crea una nueva venta con total inicial de 0
        para que luego el sistema calcule el total en
        base a los detalles de la venta */
    INSERT INTO venta(fecha,clienteId,total)
    VALUES (NOW(), inClienteId, 0);

    /* Se saca el valor del id para utilizarlo luego */
    SET outVentaId = LAST_INSERT_ID();
END $$
DELIMITER ;




DELIMITER $$
DROP PROCEDURE IF EXISTS registrarDetalleVenta$$
CREATE PROCEDURE RegistrarDetalleVenta(
    IN inVentaId INT,
    IN inBicicletaId INT,
    IN inCantidad INT
)
BEGIN
    DECLARE precioUnitario DECIMAL(10, 2);
    DECLARE totalDetalle DECIMAL(10, 2);
    DECLARE totalActual DECIMAL(10, 2);

    SELECT precio INTO precioUnitario
    FROM bicicleta
    WHERE id = inBicicletaId;

    SET totalDetalle = precioUnitario * inCantidad;

    INSERT INTO detalle_Venta (id_venta, id_bicicleta, cantidad, precio_unitario)
    VALUES (inVentaId, inBicicletaId, inCantidad, precioUnitario);

    SELECT COALESCE(total, 0) INTO totalActual
    FROM venta
    WHERE id = inVentaId;

    UPDATE venta
    SET total = totalActual + totalDetalle
    WHERE id = inVentaId;

    UPDATE bicicleta
    SET stock = stock - inCantidad
    WHERE id = inBicicletaId;
END $$
DELIMITER ;


triggers


DELIMITER $$
DROP TRIGGER IF EXISTS verificarStockAntesDeVenta$$
CREATE TRIGGER verificarStockAntesDeVenta
BEFORE INSERT ON detalle_Venta
FOR EACH ROW
BEGIN
    DECLARE stockActual INT;
    
    -- Obtener el stock actual de la bicicleta --
    SELECT stock INTO stockActual
    FROM bicicleta
    WHERE id = NEW.id_bicicleta;
    
    -- Verificar que el stock sea suficiente --
    IF stockActual < NEW.cantidad THEN
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Stock insuficiente para la bicicleta seleccionada';
    END IF;
END;

